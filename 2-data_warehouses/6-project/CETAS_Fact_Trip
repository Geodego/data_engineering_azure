-- Make sure to replace 'your_data_source'
-- with the actual names of your data source
-- Use CETAS to export select statement
IF OBJECT_ID('dbo.Fact_Trip') IS NOT NULL
BEGIN
  DROP EXTERNAL TABLE [dbo].[Fact_Trip];
END

CREATE EXTERNAL TABLE dbo.fact_trip
WITH (
    LOCATION    = 'fact_bike_trips',
    DATA_SOURCE = 'mydlsfs20230413_mydls20230413_dfs_core_windows_net',
	FILE_FORMAT = 'SynapseDelimitedTextFormat'
)
AS
SELECT
    tri.trip_id,
    tri.start_station_id,
    tri.end_station_id,
    DATEDIFF(minute, tri.started_at, tri.ended_at) AS duration_in_minutes,
    DATEDIFF(year, rid.birthday, tri.started_at) AS rider_age,
    tri.started_at,
    tri.ended_at,
    CAST(CONVERT(VARCHAR(10), tri.start_at, 112) as INT) AS date_key,
    DATEPART(hour, tri.start_at) AS starting_hour
FROM [dbo].[Trip] tri
INNER JOIN [dbo].[Rider] rid ON tri.member_id = rid.rider_id;
GO

-- Query the newly created CETAS external table
SELECT TOP 100 * FROM dbo.fact_trip
GO
